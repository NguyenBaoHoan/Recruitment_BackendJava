package com.example.jobhunter.playwright.tests;

import com.example.jobhunter.playwright.base.BasePlaywrightTest;
import com.example.jobhunter.playwright.pages.RegisterPage;
import com.microsoft.playwright.Locator;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Register Page E2E Tests
 * 
 * Test Coverage:
 * - Happy Path: ƒêƒÉng k√Ω th√†nh c√¥ng
 * - Validation Tests: Ki·ªÉm tra validation form (client-side)
 * - Server Error Tests: Ki·ªÉm tra l·ªói t·ª´ server (email ƒë√£ t·ªìn t·∫°i...)
 * - Navigation Tests: Ki·ªÉm tra chuy·ªÉn h∆∞·ªõng
 * 
 * Format: D·ª±a theo LoginPlaywrightTest v·ªõi m√†u s·∫Øc v√† log chi ti·∫øt
 */
@DisplayName("Register Page E2E Tests")
public class RegisterPlaywrightTest extends BasePlaywrightTest {

    // ========================================
    // ANSI COLOR CODES - ƒê·ªÉ console ƒë·∫πp h∆°n
    // ========================================

    private static final String RESET = "\u001B[0m";
    private static final String GREEN = "\u001B[32m";
    private static final String YELLOW = "\u001B[33m";
    private static final String BLUE = "\u001B[34m";
    private static final String CYAN = "\u001B[36m";
    private static final String RED = "\u001B[31m";

    // ========================================
    // HAPPY PATH TEST - ƒêƒÉng k√Ω th√†nh c√¥ng
    // ========================================

    @Test
    @DisplayName("DK01: ƒêƒÉng k√Ω th√†nh c√¥ng v·ªõi th√¥ng tin h·ª£p l·ªá")
    void testRegister_Success() {
        System.out.println(CYAN + "üöÄ Starting test: DK01 - Register Success" + RESET);
        RegisterPage registerPage = new RegisterPage(page);

        // Given
        System.out.println(YELLOW + "üìç Step 1: Navigate to register page" + RESET);
        registerPage.navigate();

        // When
        System.out.println(YELLOW + "üìç Step 2: Fill form with valid data and submit" + RESET);
        String testEmail = "newuser_" + System.currentTimeMillis() + "@example.com";
        registerPage.registerQuick("Nguy·ªÖn VƒÉn A", testEmail, "Password123");

        // Then
        System.out.println(YELLOW + "üìç Step 3: Verify redirect to login page" + RESET);
        page.waitForURL(FRONTEND_URL + "/login");
        assertTrue(page.url().contains("/login"), "URL n√™n ch·ª©a /login sau khi ƒëƒÉng k√Ω th√†nh c√¥ng");
        System.out.println(GREEN + "‚úÖ Test Passed: ƒêƒÉng k√Ω th√†nh c√¥ng v√† redirect ƒë·∫øn login!" + RESET);
    }

    // ========================================
    // VALIDATION TESTS - Ki·ªÉm tra validation client-side
    // ========================================

    @Test
    @DisplayName("DK02: Th·∫•t b·∫°i khi ƒë·ªÉ tr·ªëng t√™n")
    void testRegister_Fails_WhenNameIsEmpty() {
        System.out.println(CYAN + "üöÄ Starting test: DK02 - Empty Name" + RESET);
        RegisterPage registerPage = new RegisterPage(page);

        // Given
        System.out.println(YELLOW + "üìç Step 1: Navigate to register page" + RESET);
        registerPage.navigate();

        // When
        System.out.println(YELLOW + "üìç Step 2: Fill form with empty name" + RESET);
        registerPage.fillName(""); // T√™n tr·ªëng
        registerPage.fillEmail("test@example.com");
        registerPage.fillPassword("Password123");
        registerPage.fillConfirmPassword("Password123");
        registerPage.checkTermsCheckbox();
        registerPage.clickRegister();

        // Then
        System.out.println(YELLOW + "üìç Step 3: Verify 'Name is required' error" + RESET);
        Locator errorLocator = page.getByText("Name is required");
        errorLocator.waitFor();
        String errorText = errorLocator.textContent();

        System.out.println(BLUE + "Validation Message: " + errorText + RESET);
        assertEquals("Name is required", errorText.trim(), "N√™n hi·ªÉn th·ªã l·ªói 'Name is required'");
        assertFalse(page.url().contains("/login"), "Kh√¥ng n√™n redirect khi t√™n tr·ªëng");
        System.out.println(GREEN + "‚úÖ Test Passed: Hi·ªÉn th·ªã l·ªói t√™n tr·ªëng." + RESET);
    }

    @Test
    @DisplayName("DK03: Th·∫•t b·∫°i khi ƒë·ªÉ tr·ªëng email")
    void testRegister_Fails_WhenEmailIsEmpty() {
        System.out.println(CYAN + "üöÄ Starting test: DK03 - Empty Email" + RESET);
        RegisterPage registerPage = new RegisterPage(page);

        // Given
        System.out.println(YELLOW + "üìç Step 1: Navigate to register page" + RESET);
        registerPage.navigate();

        // When
        System.out.println(YELLOW + "üìç Step 2: Fill form with empty email" + RESET);
        registerPage.fillName("Nguy·ªÖn VƒÉn A");
        registerPage.fillEmail(""); // Email tr·ªëng
        registerPage.fillPassword("Password123");
        registerPage.fillConfirmPassword("Password123");
        registerPage.checkTermsCheckbox();
        registerPage.clickRegister();

        // Then
        System.out.println(YELLOW + "üìç Step 3: Verify 'Email is required' error" + RESET);
        Locator errorLocator = page.getByText("Email is required");
        errorLocator.waitFor();
        String errorText = errorLocator.textContent();

        System.out.println(BLUE + "Validation Message: " + errorText + RESET);
        assertEquals("Email is required", errorText.trim(), "N√™n hi·ªÉn th·ªã l·ªói 'Email is required'");
        assertFalse(page.url().contains("/login"), "Kh√¥ng n√™n redirect khi email tr·ªëng");
        System.out.println(GREEN + "‚úÖ Test Passed: Hi·ªÉn th·ªã l·ªói email tr·ªëng." + RESET);
    }

    @Test
    @DisplayName("DK04: Th·∫•t b·∫°i khi ƒë·ªÉ tr·ªëng password")
    void testRegister_Fails_WhenPasswordIsEmpty() {
        System.out.println(CYAN + "üöÄ Starting test: DK04 - Empty Password" + RESET);
        RegisterPage registerPage = new RegisterPage(page);

        // Given
        System.out.println(YELLOW + "üìç Step 1: Navigate to register page" + RESET);
        registerPage.navigate();

        // When
        System.out.println(YELLOW + "üìç Step 2: Fill form with empty password" + RESET);
        registerPage.fillName("Nguy·ªÖn VƒÉn A");
        registerPage.fillEmail("test@example.com");
        registerPage.fillPassword(""); // Password tr·ªëng
        registerPage.fillConfirmPassword("");
        registerPage.checkTermsCheckbox();
        registerPage.clickRegister();

        // Then
        System.out.println(YELLOW + "üìç Step 3: Verify 'Password is required' error" + RESET);
        Locator errorLocator = page.getByText("Password is required");
        errorLocator.waitFor();
        String errorText = errorLocator.textContent();

        System.out.println(BLUE + "Validation Message: " + errorText + RESET);
        assertEquals("Password is required", errorText.trim(), "N√™n hi·ªÉn th·ªã l·ªói 'Password is required'");
        assertFalse(page.url().contains("/login"), "Kh√¥ng n√™n redirect khi password tr·ªëng");
        System.out.println(GREEN + "‚úÖ Test Passed: Hi·ªÉn th·ªã l·ªói password tr·ªëng." + RESET);
    }

    @Test
    @DisplayName("DK06: Th·∫•t b·∫°i khi password kh√¥ng kh·ªõp")
    void testRegister_Fails_WhenPasswordsDoNotMatch() {
        System.out.println(CYAN + "üöÄ Starting test: DK06 - Passwords Do Not Match" + RESET);
        RegisterPage registerPage = new RegisterPage(page);

        // Given
        System.out.println(YELLOW + "üìç Step 1: Navigate to register page" + RESET);
        registerPage.navigate();

        // When
        System.out.println(YELLOW + "üìç Step 2: Fill form with mismatched passwords" + RESET);
        registerPage.fillName("Nguy·ªÖn VƒÉn A");
        registerPage.fillEmail("test@example.com");
        registerPage.fillPassword("Password123");
        registerPage.fillConfirmPassword("Password456"); // Kh√¥ng kh·ªõp
        registerPage.checkTermsCheckbox();
        registerPage.clickRegister();

        // Then
        System.out.println(YELLOW + "üìç Step 3: Verify 'Passwords do not match' error" + RESET);
        Locator errorLocator = page.getByText("Passwords do not match");
        errorLocator.waitFor();
        String errorText = errorLocator.textContent();

        System.out.println(BLUE + "Validation Message: " + errorText + RESET);
        assertEquals("Passwords do not match", errorText.trim(),
                "N√™n hi·ªÉn th·ªã l·ªói 'Passwords do not match'");
        assertFalse(page.url().contains("/login"), "Kh√¥ng n√™n redirect khi password kh√¥ng kh·ªõp");
        System.out.println(GREEN + "‚úÖ Test Passed: Hi·ªÉn th·ªã l·ªói password kh√¥ng kh·ªõp." + RESET);
    }

    @Test
    @DisplayName("DK07: Th·∫•t b·∫°i khi email sai ƒë·ªãnh d·∫°ng")
    void testRegister_Fails_WhenEmailFormatIsInvalid() {
        System.out.println(CYAN + "üöÄ Starting test: DK07 - Invalid Email Format" + RESET);
        RegisterPage registerPage = new RegisterPage(page);

        // Given
        System.out.println(YELLOW + "üìç Step 1: Navigate to register page" + RESET);
        registerPage.navigate();

        // When
        System.out.println(YELLOW + "üìç Step 2: Fill form with invalid email format" + RESET);
        registerPage.fillName("Nguy·ªÖn VƒÉn A");
        page.fill("input[name='email']", "email-sai-dinh-dang"); // Email sai ƒë·ªãnh d·∫°ng
        registerPage.fillPassword("Password123");
        registerPage.fillConfirmPassword("Password123");
        registerPage.checkTermsCheckbox();
        registerPage.clickRegister();

        // Then
        System.out.println(YELLOW + "üìç Step 3: Verify browser validation error" + RESET);
        String validationMessage = page.locator("input[name='email']")
                .evaluate("el => el.validationMessage")
                .toString();

        System.out.println(BLUE + "Browser Validation Message: " + validationMessage + RESET);
        assertTrue(
                validationMessage.contains("Please include an '@'") ||
                        validationMessage.contains("Vui l√≤ng bao g·ªìm"),
                "N√™n hi·ªÉn th·ªã th√¥ng b√°o l·ªói ƒë·ªãnh d·∫°ng email");
        assertFalse(page.url().contains("/login"), "Kh√¥ng n√™n redirect khi email sai ƒë·ªãnh d·∫°ng");
        System.out.println(GREEN + "‚úÖ Test Passed: Hi·ªÉn th·ªã l·ªói ƒë·ªãnh d·∫°ng email." + RESET);
    }

    @Test
    @DisplayName("DK08: Th·∫•t b·∫°i khi t√™n ch·ªâ ch·ª©a s·ªë")
    void testRegister_Fails_WhenNameContainsOnlyNumbers() {
        System.out.println(CYAN + "üöÄ Starting test: DK08 - Name Contains Only Numbers" + RESET);
        RegisterPage registerPage = new RegisterPage(page);

        // Given
        System.out.println(YELLOW + "üìç Step 1: Navigate to register page" + RESET);
        registerPage.navigate();

        // When
        System.out.println(YELLOW + "üìç Step 2: Fill form with numeric name" + RESET);
        registerPage.fillName("12345"); // T√™n ch·ªâ c√≥ s·ªë
        registerPage.fillEmail("test@example.com");
        registerPage.fillPassword("Password123");
        registerPage.fillConfirmPassword("Password123");
        registerPage.checkTermsCheckbox();
        registerPage.clickRegister();

        // Then
        System.out.println(YELLOW + "üìç Step 3: Verify 'Name should only contain letters' error" + RESET);
        Locator errorLocator = page.getByText("Name should only contain letters");
        errorLocator.waitFor();
        String errorText = errorLocator.textContent();

        System.out.println(BLUE + "Validation Message: " + errorText + RESET);
        assertEquals("Name should only contain letters", errorText.trim(),
                "N√™n hi·ªÉn th·ªã l·ªói 'Name should only contain letters'");
        assertFalse(page.url().contains("/login"), "Kh√¥ng n√™n redirect khi t√™n kh√¥ng h·ª£p l·ªá");
        System.out.println(GREEN + "‚úÖ Test Passed: Hi·ªÉn th·ªã l·ªói t√™n ch·ªâ c√≥ s·ªë." + RESET);
    }

    // ========================================
    // NAVIGATION TESTS - Ki·ªÉm tra chuy·ªÉn h∆∞·ªõng
    // ========================================

    @Test
    @DisplayName("Navigation: Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang Login")
    void testNavigation_ToLoginPage() {
        System.out.println(CYAN + "üöÄ Starting test: Navigation - To Login Page" + RESET);
        RegisterPage registerPage = new RegisterPage(page);

        // Given
        System.out.println(YELLOW + "üìç Step 1: Navigate to register page" + RESET);
        registerPage.navigate();

        // When
        System.out.println(YELLOW + "üìç Step 2: Click login link" + RESET);
        registerPage.clickLoginLink();

        // Then
        System.out.println(YELLOW + "üìç Step 3: Verify redirect to login page" + RESET);
        page.waitForURL(FRONTEND_URL + "/login");
        assertTrue(page.url().contains("/login"), "URL n√™n ch·ª©a /login");
        System.out.println(GREEN + "‚úÖ Test Passed: Navigate to login page successfully!" + RESET);
    }

}
